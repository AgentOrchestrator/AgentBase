# AI Summary Feature

This feature automatically generates AI-powered summaries for chat sessions using GPT-4o-mini. The summaries analyze user intent, identify problems, and track progress patterns.

## Features

- **Automatic Summarization**: GPT-4o-mini analyzes each session to provide insights on:
  - What the user is attempting to accomplish
  - Current problems or errors being encountered
  - Whether the user is making progress or stuck in a loop

- **Efficient Updates**: Summaries are only regenerated when message count changes

- **Periodic Background Updates**: The daemon runs updates every 5 minutes for sessions active in the last hour

- **Secure Architecture**: All AI processing and secret keys are kept in the backend daemon, never exposed to the web app

## Architecture

### Security Model ✅

**IMPORTANT**: Secrets (OpenAI API keys, service role keys) are stored ONLY in the `agent-orchestrator-daemon`, never in the web application. This ensures:
- ✅ Web app cannot be compromised to leak API keys
- ✅ Centralized secret management in backend
- ✅ Backend-controlled rate limiting and costs
- ✅ No serverless function cold starts with sensitive data

### Components

#### Backend Daemon (`agent-orchestrator-daemon`)

**`src/summarizer.ts`** - Core AI summary service:
- `generateSessionSummary()` - Calls GPT-4o-mini to analyze messages
- `getSessionsNeedingSummaryUpdate()` - Finds sessions needing updates (within 1 hour, message count changed)
- `updateSessionSummary()` - Updates a single session summary
- `batchUpdateSessionSummaries()` - Batch processes multiple sessions
- `runPeriodicSummaryUpdate()` - Main periodic update function

**`src/index.ts`** - Daemon main loop:
- Watches for new chat histories
- Runs AI summary updater every 5 minutes
- Gracefully handles missing OpenAI API key

#### Web Frontend (`web`)

**`components/chat-histories-list.tsx`** - UI component:
- Displays AI summaries in blue highlighted boxes
- Shows relative timestamp for summary generation
- Real-time updates via Supabase subscriptions
- Read-only access (no secrets stored)

**`lib/supabase.ts`** - TypeScript types:
- `ChatHistory` type includes AI summary fields
- Only uses public anon key for read access

### Database Schema

Three columns in `chat_histories` table:

```sql
ai_summary              TEXT                      -- AI-generated summary
ai_summary_generated_at TIMESTAMP WITH TIME ZONE  -- When generated
ai_summary_message_count INTEGER                  -- Message count at generation
```

Index for efficient querying:
```sql
CREATE INDEX idx_chat_histories_summary_update
ON chat_histories (updated_at DESC)
WHERE ai_summary_generated_at IS NULL
   OR ai_summary_message_count < jsonb_array_length(messages);
```

## Setup

### 1. Configure Backend Daemon

Add to `agent-orchestrator-daemon/.env`:

```bash
# Required for database write access
SUPABASE_URL=http://127.0.0.1:54321
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Required for AI summaries
OPENAI_API_KEY=sk-your_openai_api_key
```

### 2. Configure Web App

Add to `web/.env.local`:

```bash
# Read-only access (anon key is safe to use)
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
```

**Note**: Web app does NOT need OpenAI API key or service role key!

### 3. Run the Daemon

```bash
cd agent-orchestrator-daemon
npm run dev
```

The daemon will:
1. Watch for new chat histories
2. Upload them to Supabase
3. Run AI summary updates every 5 minutes

### 4. Run the Web App

```bash
cd web
npm run dev
```

The web app will display summaries as they're generated by the daemon.

## How It Works

### Update Flow

1. **User creates/updates session** → Daemon uploads to Supabase
2. **Every 5 minutes**, daemon checks:
   - Sessions active in last 1 hour
   - Sessions where message count ≠ `ai_summary_message_count`
3. **Daemon generates summaries**:
   - Calls GPT-4o-mini with conversation transcript
   - Stores summary + metadata in database
4. **Web UI updates in real-time**:
   - Supabase real-time subscription picks up changes
   - Summary appears on session card

### Security Benefits

```
┌─────────────┐                    ┌──────────────────┐
│   Web App   │◄───Read Only───────┤    Supabase      │
│ (Public)    │   (Anon Key)       │   (Database)     │
└─────────────┘                    └──────────────────┘
                                            ▲
                                            │
                                     Write + AI Process
                                            │
                                    ┌───────┴──────────┐
                                    │  Backend Daemon  │
                                    │  (Secrets Here)  │
                                    │  - Service Key   │
                                    │  - OpenAI Key    │
                                    └──────────────────┘
```

## Usage

### For End Users

Summaries appear automatically on the chat histories page when you visit `/`. No action needed!

### For Developers

#### Manual Testing

You can test the summarizer directly from the daemon:

```typescript
// In agent-orchestrator-daemon/src/index.ts or a test script
import { runPeriodicSummaryUpdate } from './summarizer.js';

await runPeriodicSummaryUpdate();
```

#### Check Logs

The daemon logs summary operations:

```bash
npm run dev

# Look for:
[Summary Updater] Starting periodic summary update...
[Summary Updater] Found 5 sessions needing summary updates
[Summary Updater] Update complete: { total: 5, updated: 5, errors: 0 }
```

## Performance Considerations

1. **Caching**: Summaries cached based on message count - only regenerated when messages change

2. **Rate Limiting**: Daemon runs every 5 minutes to avoid OpenAI rate limits

3. **Cost**: GPT-4o-mini is very inexpensive:
   - ~$0.15 per 1M input tokens
   - ~$0.60 per 1M output tokens
   - Typical session: < $0.001

4. **Incremental**: Only checks sessions from last hour, minimizing DB queries

5. **No Cold Starts**: Daemon always running, no serverless cold starts

## Monitoring

### Check Daemon Status

```bash
cd agent-orchestrator-daemon
npm run dev

# Should see:
# Agent Orchestrator Daemon Starting...
# Starting AI summary updater (runs every 5 minutes)...
# [Summary Updater] Starting periodic summary update...
```

### Verify Database Updates

```sql
SELECT
  id,
  ai_summary,
  ai_summary_generated_at,
  ai_summary_message_count,
  jsonb_array_length(messages) as current_message_count
FROM chat_histories
WHERE ai_summary IS NOT NULL
ORDER BY ai_summary_generated_at DESC
LIMIT 10;
```

## Troubleshooting

### Summaries Not Appearing

1. **Check daemon is running**:
   ```bash
   ps aux | grep "tsx src/index.ts"
   ```

2. **Check OpenAI API key**:
   ```bash
   # In daemon directory
   cat .env | grep OPENAI_API_KEY
   ```

3. **Check daemon logs** for errors

4. **Verify database migration applied**:
   ```sql
   \d chat_histories
   # Should show ai_summary columns
   ```

### Daemon Not Processing

1. Check `.env` file has correct values
2. Check Supabase is running: `http://127.0.0.1:54321`
3. Check service role key has write permissions

### Web App Not Showing Summaries

1. Check real-time subscription is active (check browser console)
2. Verify anon key matches Supabase project
3. Try refreshing the page

## Future Enhancements

- [ ] User-triggered summary regeneration (via daemon API)
- [ ] Webhook notifications when user is stuck
- [ ] Summary quality ratings
- [ ] Historical summary tracking
- [ ] Multi-language support
- [ ] Custom prompts per agent type

## Why This Architecture?

This design follows security best practices:

1. **Principle of Least Privilege**: Web app only has read access
2. **Defense in Depth**: Even if web app is compromised, no secrets leak
3. **Separation of Concerns**: Backend handles AI, frontend handles display
4. **Cost Control**: Backend controls OpenAI usage and rate limits
5. **Reliability**: Long-running daemon vs. serverless cold starts
